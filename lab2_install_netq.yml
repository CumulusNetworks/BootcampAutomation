---
- hosts: leaf
  remote_user: cumulus
  become: yes
  tasks:
    - name: Install Cumulus NetQ
      apt: name=cumulus-netq update_cache=yes

    - name: Add Mgmt VRF
      nclu: 
        commands:
        - add vrf mgmt
        commit: true
        description: "Lab 2: Installing Netq"

    - name: Copy Netq Configuration File
      copy: src=netq.yml dest=/etc/netq/netq.yml

    - name: Stop Existing Netq Daemons (netqd and netq-agent)
      service: name={{item}} state=stopped enabled=no
      with_items:
      - "netq-agent"
      - "netqd"

    - name: Start Netq Daemons in MGMT VRF (netqd@mgmt and netq-agent@mgmt)
      service: name={{item}} state=started enabled=yes
      with_items:
      - "netq-agent@mgmt"
      - "netqd@mgmt"
    

- hosts: server
  remote_user: cumulus
  become: yes
  tasks:
    - name: Install NetQ Repo Key
      shell: wget -O- https://hostapps3.cumulusnetworks.com/setup/cumulus-host-ubuntu.pubkey | apt-key add -

    - name: Install NetQ Repo Source
      shell: wget -O- https://hostapps3.cumulusnetworks.com/setup/cumulus-host-ubuntu-xenial.list > /etc/apt/sources.list.d/cumulus-host-ubuntu-xenial.list

    - name: Install Cumulus NetQ
      apt: name=cumulus-netq update_cache=yes

    - name: Restart Syslog
      service: name=rsyslog state=restarted

    - name: Enable and Start Netq
      service: name=netqd state=started enabled=yes

    - name: Wait for Netqd to Start
      pause:
       seconds: 7

    - name: Install Telemetry Server
      shell: netq add server 192.168.0.254; netq agent restart

